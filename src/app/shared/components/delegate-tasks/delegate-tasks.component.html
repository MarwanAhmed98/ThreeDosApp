<div class="animate-in fade-in duration-500">
    <!-- Header Section -->
    <div class="mb-6 md:mb-8">
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight text-main">
            My Tasks
        </h1>
        <p class="text-muted mt-1 text-sm md:text-base">
            View and submit your assigned tasks.
        </p>
    </div>

    <!-- Search Bar -->
    <div class="mb-6">
        <div class="relative max-w-md">
            <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-muted">
                <i class="fas fa-search"></i>
            </span>
            <input type="text" placeholder="Search tasks..." (input)="onSearchChange($event)"
                class="w-full pl-12 pr-4 py-3 rounded-2xl border border-main bg-surface shadow-sm focus:ring-4 focus:ring-accent/10 focus:border-accent transition-all text-sm text-main placeholder-muted" />
        </div>
    </div>

    <!-- Loading State -->
    @if (loading()) {
    <div class="flex justify-center items-center py-12">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-accent"></div>
    </div>
    }

    <!-- Tasks Grid -->
    @if (!loading()) {
    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        @for (task of filteredTasks(); track task.id) {
        <div
            class="bg-surface rounded-2xl border border-main shadow-sm hover:shadow-md transition-all duration-200 overflow-hidden">
            <!-- Task Header -->
            <div class="p-6 pb-4">
                <div class="flex items-start justify-between mb-3">
                    <h3 class="font-bold text-main text-lg line-clamp-2">{{ task.title }}</h3>
                </div>

                <p class="text-muted text-sm line-clamp-3 mb-4">{{ task.description }}</p>

                <!-- Task Meta Info -->
                <div class="space-y-2 text-sm">
                    <div class="flex items-center gap-2 text-muted">
                        <i class="fas fa-calendar-alt text-accent"></i>
                        <span>Due: {{ formatDate(task.due_date) }}</span>
                        @if (isTaskOverdue(task.due_date)) {
                        <span class="text-red-500 font-semibold">(Overdue)</span>
                        }
                    </div>

                    @if (task.council_name) {
                    <div class="flex items-center gap-2 text-muted">
                        <i class="fas fa-building text-accent"></i>
                        <span>{{ task.council_name }}</span>
                    </div>
                    }

                    @if (task.council_session) {
                    <div class="flex items-center gap-2 text-muted">
                        <i class="fas fa-users text-accent"></i>
                        <span>{{ task.council_session }}</span>
                    </div>
                    }
                </div>
            </div>

            <!-- Submission Status -->
            <div class="px-6 pb-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-muted">Status:</span>
                        <span
                            [class]="'px-3 py-1 rounded-full text-xs font-bold ' + getStatusClass(task.submissionStatus || 'not submitted')">
                            {{ task.submissionStatus || 'Not Submitted' }}
                        </span>
                    </div>

                    @if (task.submissionDate) {
                    <span class="text-xs text-muted">
                        Submitted {{ formatDate(task.submissionDate) }}
                    </span>
                    }
                </div>
            </div>

            <!-- Action Button -->
            <div class="px-6 pb-6">
                @if (!task.hasSubmission) {
                <button (click)="openSubmissionModal(task)"
                    class="w-full bg-accent text-white py-3 px-4 rounded-xl font-semibold hover:bg-accent/90 transition-all shadow-sm active:scale-95">
                    <i class="fas fa-upload mr-2"></i>
                    Submit Task
                </button>
                } @else {
                <button disabled
                    class="w-full bg-gray-100 text-gray-500 py-3 px-4 rounded-xl font-semibold cursor-not-allowed">
                    <i class="fas fa-check mr-2"></i>
                    Already Submitted
                </button>
                }
            </div>
        </div>
        }
    </div>

    <!-- Empty State -->
    @if (filteredTasks().length === 0) {
    <div class="text-center py-12">
        <div class="w-24 h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
            <i class="fas fa-tasks text-2xl text-gray-400"></i>
        </div>
        <h3 class="text-lg font-semibold text-main mb-2">No tasks found</h3>
        <p class="text-muted">
            @if (searchText()) {
            Try adjusting your search terms.
            } @else {
            You don't have any tasks assigned yet.
            }
        </p>
    </div>
    }

    <!-- Pagination -->
    @if (totalPages() > 1) {
    <div class="mt-8 flex items-center justify-center gap-2">
        <button (click)="changePage(currentPage() - 1)" [disabled]="currentPage() === 1"
            class="px-4 py-2 border border-main bg-surface rounded-xl hover:bg-accent/5 transition-all text-main shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-chevron-left"></i>
        </button>

        <span class="px-4 py-2 text-sm text-muted">
            Page {{ currentPage() }} of {{ totalPages() }}
        </span>

        <button (click)="changePage(currentPage() + 1)" [disabled]="currentPage() === totalPages()"
            class="px-4 py-2 border border-main bg-surface rounded-xl hover:bg-accent/5 transition-all text-main shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
    }
    }
</div>

<!-- Task Submission Modal -->
@if (isSubmissionModalOpen()) {
<div class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity" aria-hidden="true"
            (click)="closeSubmissionModal()"></div>

        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div
            class="inline-block align-bottom bg-surface border border-main rounded-3xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full animate-in">
            <form [formGroup]="submissionForm" (ngSubmit)="submitTask()">
                <div class="bg-surface px-6 pt-6 pb-4">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-main" id="modal-title">
                                Submit Task
                            </h3>
                            <p class="text-sm text-muted mt-1">{{ selectedTask()?.title }}</p>
                        </div>
                        <button type="button" (click)="closeSubmissionModal()"
                            class="text-muted hover:text-main transition-colors">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="space-y-4">
                        <!-- Task Details -->
                        <div class="bg-app rounded-xl p-4 border border-main">
                            <h4 class="font-semibold text-main mb-2">Task Description</h4>
                            <p class="text-sm text-muted">{{ selectedTask()?.description }}</p>
                            <div class="mt-3 flex items-center gap-4 text-sm text-muted">
                                <span>
                                    <i class="fas fa-calendar-alt mr-1"></i>
                                    Due: {{ formatDate(selectedTask()?.due_date || '') }}
                                </span>
                            </div>
                        </div>

                        <!-- Google Drive Link Input -->
                        <div>
                            <label class="block text-sm font-semibold text-main mb-2">
                                <i class="fab fa-google-drive text-blue-600 mr-2"></i>
                                Google Drive Link *
                            </label>

                            @if (!submissionUrl()) {
                            <!-- URL Input Area -->
                            <div
                                class="relative border-2 border-dashed border-main rounded-xl p-6 text-center bg-app hover:bg-accent/5 transition-all duration-200">
                                <div class="flex flex-col items-center space-y-3">
                                    <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center">
                                        <i class="fab fa-google-drive text-xl text-blue-600"></i>
                                    </div>
                                    <div>
                                        <p class="text-main font-medium">Paste your Google Drive link below</p>
                                        <p class="text-muted text-sm mt-1">Google Docs, Sheets, Slides, or Drive files
                                        </p>
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <input type="url" formControlName="driveUrl" (input)="onUrlChange($event)"
                                        placeholder="https://drive.google.com/file/d/... or https://docs.google.com/..."
                                        class="w-full px-4 py-3 border border-main rounded-xl bg-surface text-main placeholder-muted focus:ring-4 focus:ring-accent/10 focus:border-accent transition-all" />

                                    @if (submissionForm.get('driveUrl')?.touched &&
                                    submissionForm.get('driveUrl')?.errors) {
                                    <div class="mt-2 space-y-1">
                                        @if (submissionForm.get('driveUrl')?.errors?.['required']) {
                                        <p class="text-red-500 text-xs">Google Drive link is required</p>
                                        }
                                        @if (submissionForm.get('driveUrl')?.errors?.['invalidUrl']) {
                                        <p class="text-red-500 text-xs">Please enter a valid URL</p>
                                        }
                                        @if (submissionForm.get('driveUrl')?.errors?.['notGoogleDrive']) {
                                        <p class="text-red-500 text-xs">Please enter a valid Google Drive or Google Docs
                                            URL</p>
                                        }
                                    </div>
                                    }
                                </div>
                            </div>
                            } @else {
                            <!-- Selected URL Display -->
                            <div class="border border-main rounded-xl p-4 bg-app">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center">
                                            <i [class]="getDriveIcon(submissionUrl())"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-main">{{
                                                getFileTypeFromUrl(submissionUrl()) }}</p>
                                            <p class="text-xs text-muted truncate">{{ submissionUrl() }}</p>
                                        </div>
                                    </div>
                                    <button type="button"
                                        (click)="submissionUrl.set(''); submissionForm.get('driveUrl')?.setValue('')"
                                        class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-colors"
                                        title="Remove link">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>

                                <!-- Change URL button -->
                                <div class="mt-3 pt-3 border-t border-main">
                                    <button type="button"
                                        (click)="submissionUrl.set(''); submissionForm.get('driveUrl')?.setValue('')"
                                        class="text-sm text-accent hover:text-accent/80 font-medium">
                                        <i class="fas fa-exchange-alt mr-1"></i>
                                        Change link
                                    </button>
                                </div>
                            </div>
                            }

                        </div>
                    </div>
                </div>

                <div class="bg-app px-6 py-4 border-t border-main flex flex-col sm:flex-row gap-3 sm:justify-end">
                    <button type="button" (click)="closeSubmissionModal()"
                        class="px-6 py-3 border border-main bg-surface text-main rounded-xl hover:bg-accent/5 transition-all font-semibold">
                        Cancel
                    </button>
                    <button type="submit" [disabled]="!submissionUrl() || loading() || submissionForm.invalid"
                        class="px-6 py-3 bg-accent text-white rounded-xl hover:bg-accent/90 transition-all font-semibold shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
                        @if (loading()) {
                        <i class="fas fa-spinner fa-spin mr-2"></i>
                        Submitting...
                        } @else {
                        <i class="fab fa-google-drive mr-2"></i>
                        Submit Task
                        }
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
}